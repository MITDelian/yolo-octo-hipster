<html>
  <head>
    <link href="/style/rickshaw.css" media="all" rel="stylesheet" type="text/css" />
    <link href="/style/application.css" media="all" rel="stylesheet" type="text/css" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/rickshaw.js"></script>
    <script src="/js/d3.min.js"></script>
    <link>
  </head>
  <body>
    <div id="bpm">
      <h2 id="inner-bpm">
      </h2>
    </div>
    <div id="chart-holder"><div id="chart"></div></div>
    <div id="members">
      <div class="member">
        1
      </div>
    </div>
    <script>
      var graphdata = [];
      var graphing = [];
      var len = 50;
      var graph = undefined;
      var socket = io.connect('http://localhost');
      var demo = document.getElementById("demo");
      var appendData = function(data, header) {
        div = document.createElement("div");
        div.innerHTML = (header ? header+":" : "") + JSON.stringify(data);
        demo.appendChild(div);
      }
      socket.on('response', function (data) {
        console.log(data);
        // appendData(data,"response")
      });
      socket.on('bpm', function (data) {
        data.bpm = Math.round(data.bpm);
        document.getElementById("inner-bpm").innerHTML = data.bpm + " <div id='actual-bpm'>BPM</div>";
        var large = document.getElementById("bpm").offsetWidth;
        document.getElementById("bpm").style.marginLeft = -large/2;
      });
      // socket.on('newDevice', function (data) {
      //   graphdata[data.id] = [];
      //   if(!graph) {
      //     graph = new Rickshaw.Graph({
      //       element: document.querySelector("#chart"),
      //       width: window.innerWidth,
      //       height: 800,
      //       renderer: "line",
      //       min: 0,
      //       max: 4,
      //       stroke: true,
      //       strokeWidth: 8,
      //       series: [{color: "#000000", data: graphdata[data.id]}]
      //     });
      //   }
      //   graph.series.push({color: "#0000FF", data: graphdata[data.id]});
      //   graphing[data.id] = true;
      // });
      socket.on('accelData', function (data) {
        if(!graphdata[data.id]) {
          graphdata[data.id] = [];
        }
        while (graphdata[data.id].length == len) {
          graphdata[data.id].shift()
        }
        var date = (new Date(data.date)).valueOf();
        if(date) {
          graphdata[data.id].push({x:date,y:data.magnitude});
        }
        if(!graph) {
          graph = new Rickshaw.Graph({
            element: document.querySelector("#chart"),
            width: window.innerWidth,
            height: 300,
            renderer: "line",
            min: 0,
            max: 4,
            stroke: true,
            strokeWidth: 8,
            series: [{color: "#1fcc71", data: graphdata[data.id]}]
          });
          graphing[data.id] = true;
          yAxis = new Rickshaw.Graph.Axis.Y({
            graph: graph,
            tickFormat: Rickshaw.Fixtures.Number.formatKMBT
          });
          x_axis = new Rickshaw.Graph.Axis.Time({graph: graph})
        }
        if(graphing[data.id] != true) {
          if(data.id == 0) {
            graph.series.push({color: "#1fcc71", data: graphdata[data.id]});
          } else {
            graph.series.push({color: "#1fcc71", data: graphdata[data.id]});
          }
          graphing[data.id] = true;
          graphdata[data.id] = [];
        }
        graph.render();
      });
      var sendRequest = function(data) {
        // appendData(data,"request")
        socket.emit("request",data);
      }
      // To use: "sendRequest({data:"data"})
    </script>
  </body>
</html>
